<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Management - CEMS</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <header>
    <h1>Campus Events</h1>
    <p><a href="home.html">Back to Home</a></p>
  </header>

  <!-- Event Details Section -->
  <div id="event-details">
    <h2>Upcoming Events</h2>
    <div id="event-list">
      <!-- Events will be dynamically added here -->
    </div>

    <!-- Pagination controls -->
    <div id="pagination-controls">
      <!-- Pagination buttons will be added here -->
    </div>
  </div>

  <!-- Form to create a new event -->
  <div id="new-event-form-container">
    <h3>Create a New Event</h3>
    <form id="new-event-form">
      <label for="title">Title:</label>
      <input type="text" id="title" name="title" required>

      <label for="date">Date:</label>
      <input type="date" id="date" name="date" required>

      <label for="description">Description:</label>
      <textarea id="description" name="description"></textarea>

      <label for="location">Location:</label>
      <input type="text" id="location" name="location" required>

      <button type="submit">Create Event</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      let currentPage = 1; // Keep track of the current page
      const limit = 5; // Number of events per page

      // Function to fetch events with pagination
      function fetchEvents(page) {
        const token = localStorage.getItem('token'); // Get JWT token from localStorage
        fetch(`http://localhost:5000/api/events?page=${page}&limit=${limit}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`, // Send the token with the request
          }
        })
          .then(response => response.json())
          .then(data => {
            const eventList = document.getElementById('event-list');
            eventList.innerHTML = ''; // Clear the event list before updating

            // Loop through the events and display them
            if (Array.isArray(data)) {
              data.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.classList.add('event');
    
                // Format the date using moment.js (MM/DD/YYYY format)
                const formattedDate = moment(event.date).format('MM/DD/YYYY');
    
                eventItem.innerHTML = `
                  <h2>${event.title}</h2>
                  <p><strong>Date:</strong> ${formattedDate}</p>
                  <p><strong>Description:</strong> ${event.description}</p>
                  <p><strong>Location:</strong> ${event.location}</p>
                  <button onclick="updateEvent(${event.id})">Update</button>
                  <button onclick="deleteEvent(${event.id})">Delete</button>
                `;
    
                // Append the event item to the event list
                eventList.appendChild(eventItem);
              });

              // Add pagination controls
              updatePagination(page);
            } else {
              console.error("Data received is not an array:", data);
            }
          })
          .catch(error => console.error('Error fetching events:', error));
      }

      // Function to update pagination controls
      function updatePagination(page) {
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = ''; // Clear existing controls

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.disabled = page <= 1; // Disable if on the first page
        prevButton.onclick = () => {
          currentPage = page - 1;
          fetchEvents(currentPage);
        };

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.onclick = () => {
          currentPage = page + 1;
          fetchEvents(currentPage);
        };

        paginationControls.appendChild(prevButton);
        paginationControls.appendChild(nextButton);
      }

      // Initially fetch the first page of events
      fetchEvents(currentPage);

      // Handle event form submission for creating new events
      document.getElementById('new-event-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const token = localStorage.getItem('token'); // Get JWT token from localStorage

        const newEvent = {
          title: document.getElementById('title').value,
          date: document.getElementById('date').value,
          description: document.getElementById('description').value,
          location: document.getElementById('location').value
        };

        fetch('http://localhost:5000/api/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`, // Send the token with the request
          },
          body: JSON.stringify(newEvent)
        })
        .then(response => response.json())
        .then(data => {
          console.log('Event created:', data);
          // Refresh the event list after creating a new event
          fetchEvents(currentPage); // Fetch events for the current page
        })
        .catch(error => console.error('Error creating event:', error));
      });
    });

    // Function to update event
    function updateEvent(id) {
      const updatedEvent = {
        title: prompt("Enter new title:"),
        date: prompt("Enter new date:"),
        description: prompt("Enter new description:"),
        location: prompt("Enter new location:")
      };

      const token = localStorage.getItem('token'); // Get JWT token from localStorage

      fetch(`http://localhost:5000/api/events/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`, // Send the token with the request
        },
        body: JSON.stringify(updatedEvent)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Event updated:', data);
        location.reload(); // Refresh the page to show updated events
      })
      .catch(error => console.error('Error updating event:', error));
    }

    // Function to delete event
    function deleteEvent(id) {
      if (confirm("Are you sure you want to delete this event?")) {
        const token = localStorage.getItem('token'); // Get JWT token from localStorage

        fetch(`http://localhost:5000/api/events/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`, // Send the token with the request
          }
        })
        .then(response => response.json())
        .then(data => {
          console.log('Event deleted:', data);
          location.reload(); // Refresh the page to remove the event
        })
        .catch(error => console.error('Error deleting event:', error));
      }
    }
  </script>
</body>
</html>
